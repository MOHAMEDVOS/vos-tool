version: '3.8'

services:
  # FastAPI Backend Service
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: vos-backend
    environment:
      # Timezone (EST/Eastern Time)
      - TZ=America/New_York
      # Server settings
      - BACKEND_HOST=0.0.0.0
      - BACKEND_PORT=8000
      - DEBUG=${DEBUG:-false}
      
      # Frontend URL for CORS
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:8501}
      
      # Security
      - SECRET_KEY=${SECRET_KEY}
      - JWT_SECRET=${JWT_SECRET}
      
      # Database (Connecting to existing PostgreSQL)
      - DB_TYPE=postgresql
      - POSTGRES_HOST=${POSTGRES_HOST:-host.docker.internal}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-vos_tool}
      - POSTGRES_USER=${POSTGRES_USER:-vos_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      
      # File storage
      - UPLOAD_DIR=/app/Recordings
      - MAX_UPLOAD_SIZE=52428800
      
      # AssemblyAI
      - ASSEMBLYAI_API_KEY=${ASSEMBLYAI_API_KEY:-}
      - ASSEMBLYAI_POLLING_INTERVAL=${ASSEMBLYAI_POLLING_INTERVAL:-5}
      - ASSEMBLYAI_RETRY_ATTEMPTS=${ASSEMBLYAI_RETRY_ATTEMPTS:-3}
      - ASSEMBLYAI_ENABLE_SPEAKER_DIARIZATION=${ASSEMBLYAI_ENABLE_SPEAKER_DIARIZATION:-true}
      
      # ReadyMode (optional)
      - FORCE_READYMODE=${FORCE_READYMODE:-false}
      - READYMODE_USER=${READYMODE_USER:-}
      - READYMODE_PASSWORD=${READYMODE_PASSWORD:-}
    volumes:
      - recordings_data:/app/Recordings
      - dashboard_data:/app/dashboard_data
      - chrome_sessions:/app/chrome_profile_sessions
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    restart: unless-stopped
    networks:
      - vos-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G

  # Streamlit Frontend Service
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    container_name: vos-frontend
    environment:
      # Timezone (EST/Eastern Time)
      - TZ=America/New_York
      # Backend API URL
      - BACKEND_URL=${BACKEND_URL:-http://backend:8000}
      
      # Streamlit settings
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_FILE_WATCHER_TYPE=none
      
      # Deployment mode
      - DEPLOYMENT_MODE=${DEPLOYMENT_MODE:-enterprise}
      - FORCE_READYMODE=${FORCE_READYMODE:-false}
      
      # ReadyMode credentials (optional)
      - READYMODE_USER=${READYMODE_USER:-}
      - READYMODE_PASSWORD=${READYMODE_PASSWORD:-}
      
      # Database (for direct access if needed)
      - DB_TYPE=postgresql
      - POSTGRES_HOST=${POSTGRES_HOST:-host.docker.internal}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-vos_tool}
      - POSTGRES_USER=${POSTGRES_USER:-vos_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      
      # AssemblyAI (for frontend if needed)
      - ASSEMBLYAI_API_KEY=${ASSEMBLYAI_API_KEY:-}
    volumes:
      - recordings_data:/app/Recordings
      - dashboard_data:/app/dashboard_data
      - chrome_sessions:/app/chrome_profile_sessions
    ports:
      - "${FRONTEND_PORT:-8501}:8501"
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - vos-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8501/_stcore/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  # Optional: Redis for caching (if needed in future)
  redis:
    image: redis:7-alpine
    container_name: vos-redis
    command: redis-server --appendonly yes ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - vos-network
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  recordings_data:
    driver: local
  dashboard_data:
    driver: local
  chrome_sessions:
    driver: local
  redis_data:
    driver: local

networks:
  vos-network:
    driver: bridge

